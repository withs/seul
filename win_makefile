.POSIX:
.SUFFIXES:
.PHONY: clean playground pre

# yes it's weird ^^, it miss the prod/debug
# to add new components:
# $(OBJ_FOLDER)/comp.o: source_files.c
# and add $(OBJ_FOLDER)/comp.o to $(OUT_FOLDER)/$(TARGET_OUT): $(OBJ_FOLDER)/comp.o:

TARGET_TRIPLE := x86_64-windows-msvc
TARGET_OUT := seul.lib
BUILD_FOLDER = target
OBJ_FOLDER = $(BUILD_FOLDER)/$(TARGET_TRIPLE)/obj
OUT_FOLDER = $(BUILD_FOLDER)/$(TARGET_TRIPLE)

CC = clang
CFLAGS = -O3 --target=${TARGET_TRIPLE} -I ./include
LDFLAGS = -fuse-ld=lld-link --for-linker "/entry:_start" --for-linker "/subsystem:console" -nostdlib

all: pre $(OUT_FOLDER)/$(TARGET_OUT)

$(OUT_FOLDER)/$(TARGET_OUT): $(OBJ_FOLDER)/arch.lib $(OBJ_FOLDER)/arch_x64.lib $(OBJ_FOLDER)/platform.lib $(OBJ_FOLDER)/platform_windows.lib
	$(AR) -rc $@ $^
$(OBJ_FOLDER)/arch.lib: src/arch/arch_none.c src/arch/arch_internal.h
$(OBJ_FOLDER)/arch_x64.lib: src/arch/arch_x64.c src/arch/arch_internal.h
$(OBJ_FOLDER)/platform_windows.lib: src/platform/platform_windows.c 
$(OBJ_FOLDER)/platform.lib: src/platform/platform_none.c

%.lib %.c:
	 $(CC) $(CFLAGS) -c $(filter %.c,$^) -o $@
	
clean:
	rm -rf $(BUILD_FOLDER)

pre:
	mkdir -p ${OBJ_FOLDER}
	mkdir -p $(OUT_FOLDER)


# FIXME: linking with seuL.lib result in unresolved 
playground: all 
	$(CC) $(LDFLAGS) $(CFLAGS) -I include/ $(OBJ_FOLDER)/*.lib research/win_playground.c -o $(OUT_FOLDER)/playground.exe